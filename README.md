# LifeMart Safety Bot — Research Implementation

**Статус:** Исследовательская реализация  
**Ветка:** feature/meta-training-overhaul

---

## Описание

Система автоматической модерации контента для Telegram с использованием контекстных эмбеддингов и мета-классификации. Реализация ориентирована на достижение максимальной точности классификации за счёт применения семантического анализа и прототипов семейств спама.

**Валидационные метрики (n=1126):**
- ROC-AUC: 0.998
- Precision: 0.99
- Recall: 0.99
- Brier Score: 0.006

**Операционные характеристики:**
- Латентность: 850ms среднее, 1200ms p95
- Зависимости: Ollama API (обязательно), GPU рекомендуется
- Артефакты: 5 файлов, 120MB
- RAM: 500-800MB runtime

---

## Назначение

Данная реализация предназначена для:
- Исследований методов контекстной классификации текста
- Бенчмаркинга альтернативных подходов к модерации контента
- Систем с критичными требованиями к precision/recall (финансы, официальные каналы)
- Обучения специалистов техникам NLP-модерации

Не предназначена для:
- Проектов с ограниченными вычислительными ресурсами
- Систем с требованиями низкой латентности (<50ms)
- Мультичатовых архитектур без доработки
- Команд без опыта эксплуатации ML-моделей

Для production-систем с упрощёнными требованиями рекомендуется упрощённая архитектура без эмбеддингов (см. docs/MIGRATION_TO_SIMPLIFIED.md).

---

## Технические характеристики

### Архитектура классификации
- **Контекстные эмбеддинги:** E_msg (сообщение), E_ctx (история чата), E_user (история пользователя)
- **Модель эмбеддингов:** qllama/multilingual-e5-small через Ollama API
- **Прототипы семейств:** 11 кластеров (7 spam, 4 legit) через K-means
- **Мета-классификатор:** LogisticRegression на 41 признаке с CalibratedClassifierCV
- **Graceful degradation:** Работа при частичной недоступности эмбеддингов

### Политика модерации
- **Режимы:** manual (уведомления), semi-auto (уведомления + удаление), auto (все действия), legacy-manual (Keyword → TF-IDF приоритет)
- **Понижающие множители:** reply_to_staff (0.90), is_channel_announcement (0.85), whitelist (0.85), brand (0.70)
- **Runtime-конфигурация:** Изменение порогов и режимов без перезапуска через Telegram-команды

### Операционные возможности
- Детальные карточки анализа с декомпозицией решения по фильтрам
- Inline-клавиатура для быстрых действий модераторов
- Инкрементальное накопление обучающей выборки
- Автоматическое переобучение по достижении порога новых примеров

---

## Архитектура

- `bot/` — обработчики Telegram Bot API, модуль клавиатур и форматирование карточек.
- `filters/` — реализация трёх фильтров (keyword, TF‑IDF, embedding) и базовые абстракции.
- `core/` — типы данных и координатор фильтров, собирающий единый результат анализа.
- `services/` — политика (`PolicyEngine`), менеджер датасета, мета-классификатор и вспомогательные подсистемы.
- `config/` — статическая конфигурация (`config.py`) и динамическое хранилище `runtime_config`, доступное из команды `/setpolicy`.
- `scripts/` — обучение TF‑IDF (`train_tfidf.py`) и мета-классификатора (`train_meta_context.py`).
- `data/` и `models/` — исходные размеченные сообщения и артефакты машинного обучения.
- `logs/` — рабочие журналы (создаются при запуске).

---

## Требования

- Python 3.10 или новее.
- Telegram Bot API токен и служебный чат для модераторов.
- Опционально: доступ к Mistral API и/или локальная установка Ollama для генерации эмбеддингов.
- Библиотеки из `requirements.txt` (в том числе `python-telegram-bot`, `scikit-learn`, `pandas`, `httpx`, `nltk`).

---

## Быстрый старт

```bash
git clone https://github.com/your-org/LifeMart_Safety.git
cd LifeMart_Safety

python -m venv .venv
. .venv/bin/activate        # Windows: .venv\Scripts\activate
pip install -r requirements.txt

cp .env.example .env        # заполните файл значениями
python main.py
```

Бот использует polling. Для продакшена рекомендуется обертка-сервис (systemd, pm2, supervisord) с политикой рестартов.

---

## Конфигурация (.env)

| Переменная | Назначение |
|-----------|------------|
| `BOT_TOKEN` | Токен Telegram-бота. Обязателен. |
| `MODERATOR_CHAT_ID` | ID чата модераторов (можно канал или группу). |
| `WHITELIST_USER_IDS` | Список ID (через запятую), которым разрешён доступ к административным командам. |
| `POLICY_MODE` | Режим модерации: `manual` / `semi-auto` / `auto` / `legacy-manual`. |
| `META_NOTIFY`, `META_DELETE`, `META_KICK` | Пороги мета-классификатора для уведомления, удаления и кика. |
| `META_DOWNWEIGHT_*` | Коэффициенты понижения уверенности для объявлений, ответов сотрудникам и т.д. |
| `EMBEDDING_MODE` | Провайдер эмбеддингов: `api`, `ollama`, `local` или `disabled`. |
| `MISTRAL_API_KEY` | Ключ доступа к Mistral (используется при `EMBEDDING_MODE=api`). |
| `EMBEDDING_MODEL_ID`, `OLLAMA_MODEL`, `OLLAMA_BASE_URL` | Настройки выбранного провайдера эмбеддингов. |
| `CENTROIDS_PATH`, `PROTOTYPES_PATH`, `META_MODEL_PATH`, `META_CALIBRATOR_PATH` | Пути к артефактам ML. |
| `RETRAIN_THRESHOLD` | Минимальное число новых примеров для запуска `/retrain`. |
| `ANNOUNCE_BLOCKS` | Отправлять ли сообщения о блокировке в канал. |
| `LOG_LEVEL`, `DETAILED_DEBUG_INFO` | Глубина логирования и детализация карточек. |

Дополнительные параметры описаны в `config/config.py` и `docs/DYNAMIC_CONFIG.md`.

---

## Запуск и эксплуатация

- Для первой проверки достаточно локального polling (`python main.py`).
- В продуктовой среде рекомендуется ограничить доступ к машине, где работает бот, и хранить `.env` вне репозитория.
- Все логи пишутся через `utils.logger` в каталог `logs/`, а также выводятся в STDOUT.
- Режим модерации и пороги можно менять без рестарта через команды `/setpolicy`, `/setthreshold`, `/setdownweight`. Значения сохраняются в `config/runtime.py`.

---

## Команды и интерфейс

| Команда | Описание | Доступ |
|---------|----------|--------|
| `/start` | Краткая справка для пользователя или модератора. | Все |
| `/help` | Подробная справка по режимам и административным командам. | Все / Whitelist |
| `/status` | Текущее состояние фильтров и очереди модерации. | Whitelist |
| `/debug <id>` | Карточка анализа конкретного события. | Whitelist |
| `/meta_info` | Статус и параметры мета-классификатора. | Whitelist |
| `/setpolicy <mode>` | Смена режима (`manual`, `semi-auto`, `auto`, `legacy-manual`). | Whitelist |
| `/setthreshold <type> <value>` | Изменение порога (`notify`, `delete`, `kick`). | Whitelist |
| `/setdownweight <flag> <value>` | Настройка понижения уверенности. | Whitelist |
| `/resetconfig` | Сброс runtime-конфигурации к значениям `.env`. | Whitelist |
| `/retrain` | Запуск переобучения TF‑IDF на локальной выборке. | Whitelist |

Модераторы работают через встроенную inline-клавиатуру: «Бан/кик», «Не спам», а также ссылки на сообщение и диагностические блоки.

---

## Фильтры и мета-классификатор

- **Keyword Filter.** Быстрая эвристика на основе словарей и регулярных выражений. Хорошо работает на типовых шаблонах спама и даёт объяснимые триггеры.
- **TF‑IDF Filter.** Модель `scikit-learn` (логистическая регрессия) обученная на `data/messages.csv`. Предназначена для базовой вероятностной оценки.
- **Embedding Filter.** Считает косинусное сходство сообщения и прототипов спама/нормы. Поддерживает несколько провайдеров, работает с сырым текстом, контекстом чата и историей пользователя.
- **MetaClassifier.** Объединяет выходы всех фильтров, признаки контекста и whitelist-попадания. Позволяет точнее разделять серые зоны и объясняет вклад признаков (поддерживается вывод Top‑N весов).
- **PolicyEngine.** Принимает финальное решение с учётом режима работы, порогов и понижающих коэффициентов.

---

## Данные и переобучение

- Основная обучающая выборка хранится в `data/messages.csv`. Добавление новых строк через модерацию формирует основу для переобучения.
- Порог `RETRAIN_THRESHOLD` определяет, когда бот рекомендует запустить `/retrain`.
- Скрипты обучения:
  - `scripts/train_tfidf.py` — обновляет TF‑IDF модель и сохраняет артефакты в `models/`.
  - `scripts/train_meta_context.py` — формирует эмбеддинги контекста и переобучает мета-классификатор.
- Перед коммитом новых артефактов убедитесь в консистентности путей в `.env` и `config/runtime.py`.

---

## Логи и мониторинг

- Все действия модерации фиксируются в хранилище (`storage/`), а ключевые точки — в текстовых логах.
- Для оперативного контроля предусмотрены карточки с диагностикой: вероятность по каждому фильтру, активные паттерны, top‑фичи мета-модели, флаги whitelists.
- Включите `DETAILED_DEBUG_INFO=true`, чтобы видеть расширенные блоки в модераторских карточках (например, косинусные расстояния и списки признаков).

---

## Структура репозитория

```text
LifeMart_Safety/
├─ bot/                  # Обработчики, клавиатуры, форматирование карточек
├─ config/               # Настройки и runtime-конфигурация
├─ core/                 # Типы данных и координатор фильтров
├─ data/                 # Размеченные сообщения
├─ filters/              # Реализация фильтров
├─ models/               # ML-артефакты (TF-IDF, мета-классификатор, центроиды)
├─ scripts/              # Скрипты обучения
├─ services/             # Политика, датасет, мета-классификатор и пр.
├─ storage/              # Слой хранения событий модерации
├─ utils/                # Вспомогательные утилиты (логгер, текстовые фильтры)
├─ main.py               # Точка входа
├─ requirements.txt      # Зависимости
└─ docs/                 # Дополнительная документация и инструкции
```

Подробные описания отдельных подсистем — в `docs/` (`FILTER_TUNING.md`, `DYNAMIC_CONFIG.md`, `EMBEDDING_PROVIDERS.md`, `MODERATOR_UX.md` и др.).

---

## Известные ограничения

### Производительность
- Латентность 800-1200ms делает систему непригодной для высоконагруженных сценариев (>70 сообщений/мин)
- 95% времени обработки занимают вызовы Ollama API (3 эмбеддинга на сообщение)
- При отсутствии GPU время генерации одного эмбеддинга увеличивается до 2-3 секунд

### Архитектурные
- Монолитная конфигурация не поддерживает несколько чатов без рефакторинга
- Глобальная история пользователей смешивает контекст при активности в разных чатах
- Датасет не содержит поле chat_id, что препятствует обучению чат-специфичных моделей

### Операционные
- Требуется запущенный Ollama сервер с моделью multilingual-e5-small (~2GB RAM)
- Обучение мета-классификатора занимает 30-60 минут на CPU (генерация эмбеддингов для выборки)
- Graceful degradation при недоступности эмбеддингов снижает precision на 15-20%
- Необходима ML-экспертиза для обучения, калибровки порогов и мониторинга метрик

### Альтернативная архитектура
Для проектов с упрощёнными требованиями к точности доступна реализация без эмбеддингов:
- Латентность <10ms (TF-IDF + паттерн-классификатор на LightGBM)
- Нет зависимости от Ollama
- Precision 0.88-0.90, Recall 0.86-0.88 (снижение ROC-AUC на 0.08-0.10)
- Подробности: `docs/MIGRATION_TO_SIMPLIFIED.md`

---

## Документация

- `docs/ARCHITECTURE.md` — детальное описание компонентов системы
- `docs/EMBEDDINGS_META.md` — устройство эмбеддингов и мета-классификатора
- `docs/MIGRATION_PLAN.md` — план адаптации для мультичатовой архитектуры
- `docs/MIGRATION_TO_SIMPLIFIED.md` — переход на упрощённую архитектуру без эмбеддингов

---

## Лицензия

MIT License. Полный текст в файле `LICENSE`.

